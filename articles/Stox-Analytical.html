<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>StoX-Analytical-Estimates • RstoxFDA</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="StoX-Analytical-Estimates">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RstoxFDA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.0-9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Stox-Analytical.html">StoX-Analytical-Estimates</a></li>
    <li><a class="dropdown-item" href="../articles/StoX-data-preparation.html">StoX FDA data preparation (baseline)</a></li>
    <li><a class="dropdown-item" href="../articles/Stox-FDA-overview.html">StoX Fisheries overview (report)</a></li>
    <li><a class="dropdown-item" href="../articles/stox-reca.html">StoX-Reca (analysis)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/StoXProject/RstoxFDA/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>StoX-Analytical-Estimates</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/StoXProject/RstoxFDA/blob/master/vignettes/Stox-Analytical.Rmd" class="external-link"><code>vignettes/Stox-Analytical.Rmd</code></a></small>
      <div class="d-none name"><code>Stox-Analytical.Rmd</code></div>
    </div>

    
    
<p>This vignette explains how to use RstoxFDA functions in the StoX
user-interface to prepare and run analytical catch-at-age estimates.
Some data preparation may be necessary, and the vignette <a href="Stox-data-preparation.html">StoX FDA data preparation
(baseline)</a> introduces some common data-preparation tasks for catch
at age estimation, with formats commonly used at the Institute of Marine
Research (IMR). In order to make informed decisions on data preparation
and model configuration, it will be necessary to get an overview of the
fisheries and how it is covered by the available samples, for instance
using the functions introduced in <a href="Stox-FDA-overview.html">Stox
Fisheries overview (report)</a>.</p>
<p>This document introduces some problems and tasks, and how
RstoxFDA-functions may be applied to solve them. The details of how to
use the functions introduced here are provided as function documentation
viewable in the StoX “function description”-tab, or in an R-console via
‘?’, e.g:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/AnalyticalPopulationEstimate.html">AnalyticalPopulationEstimate</a></span></span></code></pre></div>
<p>The “function description”-tab in StoX have some limitations and may
not display equations. To render the equation, inspect the function
documentation in R or consult the RstoxFDA manual.</p>
<p>Documentation for data formats are provided in the same way.
E.g.:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/AnalyticalPopulationEstimateData.html">AnalyticalPopulationEstimateData</a></span></span></code></pre></div>
<p>StoX is composed of several R-packages. Functions will be referred to
by their package name with the notation <em>package::function</em>. In
the StoX user-interface, the package that functions belong to are not
visible, so the function denoted here as <em>package::function</em>,
will be available as just <em>function</em>. Any data formats are
similarly denoted <strong>package::format</strong>.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>RstoxFDA is an optional packages in StoX. In order to use the
functions introduced in this vignette in the StoX user-interface, make
sure RstoxFDA is installed. See installation instructions on <a href="https://github.com/StoXProject/RstoxFDA" class="external-link">github:
StoXProject/RstoxFDA</a>. To install the StoX user-interface, see
instructions on <a href="https://github.com/StoXProject/StoX" class="external-link">github:
StoXProject/StoX</a>.</p>
</div>
<div class="section level3">
<h3 id="sampling-parameters">Sampling parameters<a class="anchor" aria-label="anchor" href="#sampling-parameters"></a>
</h3>
<p>In order to construct StoX projects like the example below, sampling
parameters must be obtained from processes outside of StoX and formatted
as described in the documentation for
<em>RstoxFDA::ReadPSUSamplingParameters</em>. Examples provided for
testing purposes can be located internally at IMR (<a href="https://git.imr.no/pelagic/internal/fangstprovelotteriet/samplingparameters/-/tree/main/formatted_files" class="external-link uri">https://git.imr.no/pelagic/internal/fangstprovelotteriet/samplingparameters/-/tree/main/formatted_files</a>).</p>
</div>
<div class="section level2">
<h2 id="analytical-catch-at-age-estimates">Analytical catch at age estimates<a class="anchor" aria-label="anchor" href="#analytical-catch-at-age-estimates"></a>
</h2>
<p>A minimal StoX project implementing analytical catch at age estimates
with catch lottery data, could have a baseline that look something like
this:</p>
<table class="table">
<colgroup>
<col width="26%">
<col width="39%">
<col width="34%">
</colgroup>
<thead><tr class="header">
<th>Process name</th>
<th>Function</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>ReadSamples</td>
<td>ReadBiotic</td>
<td>Reads sample data</td>
</tr>
<tr class="even">
<td>StoxBiotic</td>
<td>StoxBiotic</td>
<td>Convert sample data to StoxBiotic</td>
</tr>
<tr class="odd">
<td>AddSamplingId</td>
<td>AddToStoxBiotic</td>
<td>Add serialnumber to StoxBiotic</td>
</tr>
<tr class="even">
<td>AddLengthGroups</td>
<td>AddLengthGroupStoxBiotic</td>
<td>If catch-at-length is desired. Adds a column to StoxBiotic, grouping
individuals by length.</td>
</tr>
<tr class="odd">
<td>ReadPSUsamplingParameters</td>
<td>ReadPSUSamplingParameters</td>
<td>Read sampling parameters for each haul. These ar provided from the
catch lottery.</td>
</tr>
<tr class="even">
<td>ComputeINDsamplingParameters</td>
<td>ComputeIndividualSamplingParameters</td>
<td>Defines sampling parameters for each individual, within haul.
Parameters are inferred from data with configurable assumptions.</td>
</tr>
<tr class="odd">
<td>AssignPSUSamplingParameters</td>
<td>AssignPSUSamplingParameters</td>
<td>Matches selections to data records, handles non-response
corrections</td>
</tr>
<tr class="even">
<td>EstimatePSU</td>
<td>AnalyticalPSUEstimate</td>
<td>Estimates abundance, frequencies, totals and means for each
haul</td>
</tr>
<tr class="odd">
<td>EstimatePopulation</td>
<td>AnalyticalPopulationEstimate</td>
<td>Estimates abundance, frequencies, totals and means for the
population of interest. This estimate is based only on samples, no
information about total landings have been included at this point.</td>
</tr>
<tr class="even">
<td>ReadLandings</td>
<td>ReadLandings</td>
<td>Reads census information: total landings</td>
</tr>
<tr class="odd">
<td>StoxLanding</td>
<td>StoxLanding</td>
<td>Convert census data to StoxLanding</td>
</tr>
<tr class="even">
<td>RatioEstimateTotal</td>
<td>AnalyticalRatioEstimate</td>
<td>Improves estimates with census information: total landings. This
will constitute our final estimate for the stock.</td>
</tr>
</tbody>
</table>
<p>The following functions provides reporting from analytical
estimates:</p>
<table class="table">
<colgroup>
<col width="53%">
<col width="46%">
</colgroup>
<thead><tr class="header">
<th align="left">Report function</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ReportAnalyticalCatchAtAge</td>
<td align="left">Tabulate total catch of each age group</td>
</tr>
<tr class="even">
<td align="left">PlotCatchAtAgeTotals</td>
<td align="left">Plot total catch of each age group</td>
</tr>
<tr class="odd">
<td align="left">ReportAnalyticalCatchAtLength</td>
<td align="left">Tabulate total catch of each length group</td>
</tr>
<tr class="even">
<td align="left">ReportAnalyticalLengthAtAge</td>
<td align="left">Tabulate mean length of each age group</td>
</tr>
<tr class="odd">
<td align="left">PlotMeanLengthAtAge</td>
<td align="left">Plot mean length of each age group</td>
</tr>
<tr class="even">
<td align="left">ReportAnalyticalWeightAtAge</td>
<td align="left">Tabulate mean weight of each age group</td>
</tr>
<tr class="odd">
<td align="left">PlotMeanWeightAtAge</td>
<td align="left">Plot mean weight of each age group</td>
</tr>
</tbody>
</table>
<p>In addition some functions are relevant in this context, that may
also be used with other estimation approaches, such as Reca:</p>
<table class="table">
<colgroup>
<col width="53%">
<col width="46%">
</colgroup>
<thead><tr class="header">
<th align="left">Report function</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ReportFdaSampling</td>
<td align="left">Produces overview of sampling coverage. Useful for
quality assurance.</td>
</tr>
<tr class="even">
<td align="left">ReportFdaLandings</td>
<td align="left">Produces summaries of landings.</td>
</tr>
<tr class="odd">
<td align="left">ReportFdaSOP</td>
<td align="left">Performs Sum-Of-Products tests, checking that the
products of mean weight at age and estimated catch at age sum to total
landed weight.</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="analytical-estimates-with-multi-stage-sampling">Analytical estimates with multi-stage sampling<a class="anchor" aria-label="anchor" href="#analytical-estimates-with-multi-stage-sampling"></a>
</h3>
<p>Below is provided a somewhat more detailed overview of the functions
that can be used to perform analytical estimates from fisheries
dependent sampling, and explanations for how they could be combine to
accomodate different designs.</p>
<div class="section level4">
<h4 id="stage-approximation">2-stage approximation<a class="anchor" aria-label="anchor" href="#stage-approximation"></a>
</h4>
<p>RstoxFDA provides a generic framework for analytical estimates of
multi-stage sampling data, through a 2-stage approximation. The sampling
design is conceptually divided into two steps: Selection of primary
sampling units (PSUs), and selection of individuals within each sampling
unit. If selection probabilities can be inferred for each of these two
steps, we can do the following calculations:</p>
<ul>
<li>Abundance, Frequency, Means and Totals of any variables and by any
statistical domain observed for individuals can be estimated for each
PSU. The estimation of within PSU-variance is not supported. Estimates
for each PSU is provided with the function
<em>RstoxFDA::AnalyticalPSUEstimate</em> .</li>
<li>Population quantities and associated sampling variances may then be
estimated with the function
<em>RstoxFDA::AnalyticalPopulationEstimate</em> .</li>
<li>Official landing statistics can be utilized to improve the estimate
with the function <em>RstoxFDA::AnalyticalRatioEstimate</em>.</li>
</ul>
<p>In most circumstances, only a small fraction of the PSUs available in
a stratum is actually sampled, and typically this provide a good
approximation to the sampling variance, even if within-PSU variance is
not accounted for.</p>
</div>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>As an example, we will demonstrate estimation with data from the
catch lottery for North-sea Herring in 2022. This is an unequal
probability sampling program, which selects hauls in real-time from an
active fishery, with selection probabilities proportional to the first
reports of catch size. The sampling frame covers Norwegian vessel larger
than 15 m which has declared that they are targeting herring when
leaving port, and has declared the catch to be North-Sea herring in
their live catch reports.</p>
<div class="section level4">
<h4 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h4>
<p>See the vignette <a href="Stox-data-preparation.html">StoX FDA data
preparation (baseline)</a> for how to read data. We use
<em>RstoxData::ReadBiotic</em> and <em>RstoxData::StoxBiotic</em> to get
the samples in the format we like. And then we use
<em>RstoxData::AddToStoxBiotic</em> to add the column ‘serialnumber’
which is needed for identifying which data records belong to the which
sampling parameters. The result of those operations are included in an
example data set in RstoxFDA, called ‘CatchLotteryExample’. Similarly,
we obtain landings data with <em>RstoxData::ReadLanding</em>,
<em>RstoxData::StoxLanding</em>, and <em>RstoxData::FilterLanding</em>.
An example data set with landings of North Sea Herring from Norwegian
vessels larger than 15 meters is included as an example data set in
RstoxFDA, called ‘CatchLotteryLandingExample’.</p>
</div>
<div class="section level4">
<h4 id="sampling-parameters-1">Sampling parameters<a class="anchor" aria-label="anchor" href="#sampling-parameters-1"></a>
</h4>
<div class="section level5">
<h5 id="read-psu-sampling-parameters">Read PSU sampling parameters<a class="anchor" aria-label="anchor" href="#read-psu-sampling-parameters"></a>
</h5>
<p>We will start by reading these sampling parameters, which has been
prepared outside of StoX:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DefinitionMethod</span> <span class="op">=</span> <span class="st">"ResourceFile"</span></span>
<span><span class="va">FileName</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testresources"</span>, </span>
<span>                       <span class="st">"lotteryParameters"</span>, </span>
<span>                       <span class="st">"lotteryDesignNSHstrata.txt"</span>, </span>
<span>                       package<span class="op">=</span><span class="st">"RstoxFDA"</span><span class="op">)</span></span>
<span><span class="va">PSUparameters</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/ReadPSUSamplingParameters.html">ReadPSUSamplingParameters</a></span><span class="op">(</span><span class="va">FileName</span><span class="op">)</span></span></code></pre></div>
<p>These sampling variables are design variables for the biological
records, and should conventionally be archived in the “biotic” folder in
StoX-project folder structure. If for sampling parameters for some
reason are lost, an approximation can be computed with
<em>RstoxFDA::ComputePSUSamplingParameters</em>. See the section
‘Analytical estimates for subsample of PSUs’ for an example of how to do
that.</p>
<p>Note that these files contains selection and inclusion probabilites
for every haul selected for sampling:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">PSUparameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Stratum Order SamplingUnitId InclusionProbability HTsamplingWeight</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;num&gt;         &lt;char&gt;                &lt;num&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Nordsjo    NA          38401            0.2131969      0.008946917</span></span>
<span><span class="co">#&gt; 2: Nordsjo    NA          38433            0.2474124      0.007709618</span></span>
<span><span class="co">#&gt; 3: Nordsjo    NA          38440            0.1700985      0.011213827</span></span>
<span><span class="co">#&gt; 4: Nordsjo    NA          38445            0.1089753      0.017503562</span></span>
<span><span class="co">#&gt; 5: Nordsjo    NA          38438            0.6411753      0.002974935</span></span>
<span><span class="co">#&gt; 6: Nordsjo    NA          38441            0.2339068      0.008154764</span></span>
<span><span class="co">#&gt;    SelectionProbability HHsamplingWeight SelectionDescription</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;            &lt;num&gt;               &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:          0.002177419      0.008497203                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:          0.002580645      0.007169515                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:          0.001693548      0.010924976                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:          0.001048387      0.017648038                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:          0.009274194      0.001994996                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:          0.002419355      0.007647483                 &lt;NA&gt;</span></span></code></pre></div>
<p>The column ‘SamplingUnitId’ identifies the data records for selected
hauls that have been sampled. This corresponds to ‘serialnumber’ in the
sample data. We also have records for selected hauls that was not
sampled, which gives us a basis for non-response corrections. These have
missing values in the column SamplingUnitId. You may find tabulated
below, the sampling parameters for all sampled hauls:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">PSUparameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PSUparameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">$</span><span class="va">SamplingUnitId</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Stratum Order SamplingUnitId InclusionProbability HTsamplingWeight</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;num&gt;         &lt;char&gt;                &lt;num&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Nordsjo    NA           &lt;NA&gt;           0.19908308      0.009581201</span></span>
<span><span class="co">#&gt; 2: Nordsjo    NA           &lt;NA&gt;           0.17009849      0.011213827</span></span>
<span><span class="co">#&gt; 3: Nordsjo    NA           &lt;NA&gt;           0.17009849      0.011213827</span></span>
<span><span class="co">#&gt; 4: Nordsjo    NA           &lt;NA&gt;           0.17451153      0.010930252</span></span>
<span><span class="co">#&gt; 5: Nordsjo    NA           &lt;NA&gt;           0.20263488      0.009413261</span></span>
<span><span class="co">#&gt; 6: Nordsjo    NA           &lt;NA&gt;           0.06852939      0.027834116</span></span>
<span><span class="co">#&gt;    SelectionProbability HHsamplingWeight SelectionDescription</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;            &lt;num&gt;               &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:         0.0020161290      0.009176980                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:         0.0016935484      0.010924976                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:         0.0016935484      0.010924976                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:         0.0017419355      0.010621504                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:         0.0020564516      0.008997039                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:         0.0006451613      0.028678061                 &lt;NA&gt;</span></span></code></pre></div>
<p>The samples are all selected from the same stratum, called “Nordsjo”.
Later on, we will need to put this stratum in correspondance with census
data (sales-notes). We have therefore added columns to the table
‘StratificationVariables’:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PSUparameters</span><span class="op">$</span><span class="va">StratificationVariables</span></span>
<span><span class="co">#&gt;    Stratum Species</span></span>
<span><span class="co">#&gt;     &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: Nordsjo  061104</span></span></code></pre></div>
<p>This tells use that the Stratum “Nordsjo” is defined by the Species
code “061104”, which we will later find in the landings data. You can
use other or additional columns in stead, if that is more appropriate
for your fishery or the way you prepare the landings data. You may also
use StoX functions for adding columns to the landings, to make sure that
the strata sampled are identifiable in the landings. If no
stratification variables are provided, you may add them with
<em>RstoxFDA::AddPsuStratificationVariables</em>, or you may manually
edit the resource file.</p>
<p>Ideally, the Stratification Variables should encode the sampling
frame of each stratum, so that we can be explicit about any part of the
fishery that is not covered by our sampling. The example provided here
implicitly assumes that we are covering the entire fishery, but this is
typically not true. For instance, sampling programs based in electronic
logbook reports, does not cover fishing activity from vessels without
logbooks. RstoxFDA provide functions for explicit inference to
out-of-frame strata, but they are not introduced here. Consult function
documentation for
<em>RstoxFDA::ExtendAnalyticalSamplingFrameCoverage</em>,
<em>RstoxFDA::InterpolateAnalyticalDomainEstimates</em>, and
<em>RstoxFDA::AggregateAnalyticalEstimate</em>.</p>
<p>For purposes of estimation, the case when sampling is not stratified
is the same as if we have only one stratum. So the Stratum column can
always be encoded.</p>
</div>
<div class="section level5">
<h5 id="compute-sampling-parameters-for-measurements">Compute sampling parameters for measurements<a class="anchor" aria-label="anchor" href="#compute-sampling-parameters-for-measurements"></a>
</h5>
<p>We also need to know the sampling parameters for each fish in each
haul. RstoxFDA provides support for calculating those for some common
sampling schemes. We can infer sampling parameters for observations of
individual fish within a haul with the function
<em>RstoxFDA::ComputeIndvidiualSamplingParameters</em>. In the case of
the catch lottery sampling, we will assume that fish that are selected
for measurement is a simple random sample of the catch
(DefinitionMethod=“SRS”). Sometimes different sampling schemes are
employed for different parameters, so we have to specify a set of
parameter which signals that the specimen is selected. We will specify
the selected individuals as those where either sex or age is observed,
as sex and age is always observed together in this program, and
specifying sex rather than just age allows us to catch missing age
records (due to for instance readability):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StoxBioticData</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryExample.html">CatchLotteryExample</a></span></span>
<span><span class="va">DefinitionMethod</span> <span class="op">=</span> <span class="st">"SRS"</span></span>
<span><span class="va">Parameters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualSex"</span>, <span class="st">"IndividualAge"</span><span class="op">)</span></span>
<span><span class="va">indParameters</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/ComputeIndividualSamplingParameters.html">ComputeIndividualSamplingParameters</a></span><span class="op">(</span>StoxBioticData <span class="op">=</span> <span class="va">StoxBioticData</span>, </span>
<span>                                                               DefinitionMethod <span class="op">=</span> <span class="va">DefinitionMethod</span>,</span>
<span>                                                               Parameters<span class="op">=</span><span class="va">Parameters</span><span class="op">)</span></span></code></pre></div>
<p>Note that we have obtained sampling parameters for individual fish
sampled for sex or age, the haul is identified by the column ‘SampleId’
that corresponds to ‘Haul’ in StoxBioticData, and the individual is
identified by ‘IndividualId’ which corresponds to ‘Individual’ in
StoxBioticData. Within-haul stratification is also inferred:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">indParameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;SampleId, Stratum&gt;</span></span>
<span><span class="co">#&gt;                       SampleId                                    Stratum Order</span></span>
<span><span class="co">#&gt;                         &lt;char&gt;                                     &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt; 3: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus    NA</span></span>
<span><span class="co">#&gt;                                                                  IndividualId</span></span>
<span><span class="co">#&gt;                                                                        &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-1</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-2</span></span>
<span><span class="co">#&gt; 3: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-3</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-4</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-5</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-1-38401-sild'G05/161722.G05/126417/Clupea harengus-1-6</span></span>
<span><span class="co">#&gt;    InclusionProbability HTsamplingWeight SelectionProbability HHsamplingWeight</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;            &lt;num&gt;                &lt;num&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt; 2:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt; 3:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt; 4:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt; 5:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt; 6:         3.641113e-05       0.02631579                   NA               NA</span></span>
<span><span class="co">#&gt;    SelectionDescription</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:                 &lt;NA&gt;</span></span></code></pre></div>
<div class="section level6">
<h6 id="na-domains-and-non-response-assumptions">NA-domains and non-response assumptions<a class="anchor" aria-label="anchor" href="#na-domains-and-non-response-assumptions"></a>
</h6>
<p>Missing observations of individuals results in domains with the value
NA, when these variables are used in domain definitions. For instance
the example above has fish where sex is recorded, but not age. This will
show up later as age groups with the value NA, and (minimum) Age 0. If
‘ComputeIndividualSamplingParameters had instead been defined with only
the argument “IndividualAge” for ’Parameters’, no sampling parameters
would be provided for these individuals. That would correspond to an
assumption that they where missing at random:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StoxBioticData</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryExample.html">CatchLotteryExample</a></span></span>
<span><span class="va">DefinitionMethod</span> <span class="op">=</span> <span class="st">"SRS"</span></span>
<span><span class="va">Parameters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualAge"</span><span class="op">)</span></span>
<span><span class="va">indParametersNoNA</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/ComputeIndividualSamplingParameters.html">ComputeIndividualSamplingParameters</a></span><span class="op">(</span>StoxBioticData <span class="op">=</span> <span class="va">StoxBioticData</span>, </span>
<span>                                                                   DefinitionMethod <span class="op">=</span> <span class="va">DefinitionMethod</span>,</span>
<span>                                                                   Parameters<span class="op">=</span><span class="va">Parameters</span><span class="op">)</span></span></code></pre></div>
<p>Note that some individuals are now left out of the table of sampling
parameters, and hence of subsequent computations:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">indParameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">indParameters</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">$</span><span class="va">IndividualId</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span></span>
<span>                                      <span class="va">indParametersNoNA</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">$</span><span class="va">IndividualId</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;SampleId, Stratum&gt;</span></span>
<span><span class="co">#&gt;                        SampleId                                    Stratum</span></span>
<span><span class="co">#&gt;                          &lt;char&gt;                                     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-11-38411 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-13-38413 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: NA/19/2022/10024/20-16-38416 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-21-38421 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-21-38421 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-23-38423 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;    Order</span></span>
<span><span class="co">#&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    NA</span></span>
<span><span class="co">#&gt; 2:    NA</span></span>
<span><span class="co">#&gt; 3:    NA</span></span>
<span><span class="co">#&gt; 4:    NA</span></span>
<span><span class="co">#&gt; 5:    NA</span></span>
<span><span class="co">#&gt; 6:    NA</span></span>
<span><span class="co">#&gt;                                                                    IndividualId</span></span>
<span><span class="co">#&gt;                                                                          &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-11-38411-sild'G05/161722.G05/126417/Clupea harengus-1-31</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-13-38413-sild'G05/161722.G05/126417/Clupea harengus-1-55</span></span>
<span><span class="co">#&gt; 3:  NA/19/2022/10024/20-16-38416-sild'G05/161722.G05/126417/Clupea harengus-1-1</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-21-38421-sild'G05/161722.G05/126417/Clupea harengus-1-30</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-21-38421-sild'G05/161722.G05/126417/Clupea harengus-1-31</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-23-38423-sild'G05/161722.G05/126417/Clupea harengus-1-59</span></span>
<span><span class="co">#&gt;    InclusionProbability HTsamplingWeight SelectionProbability HHsamplingWeight</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;            &lt;num&gt;                &lt;num&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:         1.829431e-05       0.02000000                   NA               NA</span></span>
<span><span class="co">#&gt; 2:         6.056471e-05       0.01666667                   NA               NA</span></span>
<span><span class="co">#&gt; 3:         4.931088e-05       0.02000000                   NA               NA</span></span>
<span><span class="co">#&gt; 4:         5.699998e-05       0.01694915                   NA               NA</span></span>
<span><span class="co">#&gt; 5:         5.699998e-05       0.01694915                   NA               NA</span></span>
<span><span class="co">#&gt; 6:         1.102286e-05       0.01666667                   NA               NA</span></span>
<span><span class="co">#&gt;    SelectionDescription</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:                 &lt;NA&gt;</span></span></code></pre></div>
<p>This assumption is commonly invoked, but ages are probably not
usually missing at random. Rather they are missing due to age-dependent
readability-issues.</p>
</div>
</div>
<div class="section level5">
<h5 id="match-sampling-parameters-to-data-records">Match sampling parameters to data records<a class="anchor" aria-label="anchor" href="#match-sampling-parameters-to-data-records"></a>
</h5>
<p>We will now put data and selections in correspondence with the
function <em>RstoxFDA::AssignPSUsamplingParameters</em>. We will
Identify hauls with the StoxBioticData variable Haul, which is how the
PSU is identified in the specification of sampling parameters for
individual fish (individualParametersData, computed above):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PSUSamplingParametersData</span> <span class="op">=</span> <span class="va">PSUparameters</span></span>
<span><span class="va">StoxBioticData</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryExample.html">CatchLotteryExample</a></span></span>
<span><span class="va">SamplingUnitId</span> <span class="op">=</span> <span class="st">"serialnumber"</span></span>
<span><span class="va">DataRecordId</span> <span class="op">=</span> <span class="st">"Haul"</span></span>
<span><span class="va">DefinitionMethod</span> <span class="op">=</span> <span class="st">"MissingAtRandom"</span></span>
<span><span class="va">PSUassigment</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AssignPSUSamplingParameters.html">AssignPSUSamplingParameters</a></span><span class="op">(</span>DefinitionMethod<span class="op">=</span><span class="va">DefinitionMethod</span>, </span>
<span>                                                     StoxBioticData<span class="op">=</span><span class="va">StoxBioticData</span>,</span>
<span>                                                     PSUSamplingParametersData<span class="op">=</span><span class="va">PSUparameters</span>,</span>
<span>                                                     SamplingUnitId<span class="op">=</span><span class="va">SamplingUnitId</span>, </span>
<span>                                                     DataRecordId<span class="op">=</span><span class="va">DataRecordId</span><span class="op">)</span></span></code></pre></div>
<p>The procedure has corrected sampling parameters for non-response, and
removed non-respondents from the table of selections. We have also
changed the content of the column ‘SamplingUnitId’, so that it now
corresponds to the column used to identify hauls in StoxBiotic:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">PSUassigment</span><span class="op">$</span><span class="va">SelectionTable</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Stratum Order               SamplingUnitId InclusionProbability</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;num&gt;                       &lt;char&gt;                &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Nordsjo    NA  NA/19/2022/10024/20-1-38401           0.15989769</span></span>
<span><span class="co">#&gt; 2: Nordsjo    NA NA/19/2022/10024/20-33-38433           0.18555930</span></span>
<span><span class="co">#&gt; 3: Nordsjo    NA NA/19/2022/10024/20-40-38440           0.12757387</span></span>
<span><span class="co">#&gt; 4: Nordsjo    NA NA/19/2022/10024/20-45-38445           0.08173144</span></span>
<span><span class="co">#&gt; 5: Nordsjo    NA NA/19/2022/10024/20-38-38438           0.48088148</span></span>
<span><span class="co">#&gt; 6: Nordsjo    NA NA/19/2022/10024/20-41-38441           0.17543012</span></span>
<span><span class="co">#&gt;    HTsamplingWeight SelectionProbability HHsamplingWeight SelectionDescription</span></span>
<span><span class="co">#&gt;               &lt;num&gt;                &lt;num&gt;            &lt;num&gt;               &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:      0.012028199          0.002177419      0.011431279                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:      0.010364779          0.002580645      0.009645141                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:      0.015075825          0.001693548      0.014697358                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:      0.023531719          0.001048387      0.023741887                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:      0.003999491          0.009274194      0.002683865                 &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:      0.010963233          0.002419355      0.010288151                 &lt;NA&gt;</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h4>
<p>Since these estimators are based on the sampling design, they are
generic with respect to variables of interest. For all numeric
variables, they can provide an estimate of totals and means by some
specified domain definition. In addition total abundance in domain and
the frequency of occurrence in domain is estimated. A domain is any
defined group of fish in the catches. Of primary interest is groups
defined by fish measurements and observations, such as age or length,
but caught fish are also distinguished by fishing activity variables,
such as the gear used to catch them, or the time of catch. For purposes
of estimation we need to distinguish between domain variables that are
exclusive to higher level selection and those that are not. Age is for
example available for any fish, so estimates of abundance in an age
group is backed by all samples. Gear is however exclusive to a catch so
estimates of abundance in gear groups are only backed by the samples
that are in that gear-domain. In this example we will only estimate
domains that are based on observations of fish, but in general this text
and the documentation for functions refer to PSU domains for the domains
that are exclusive to a primary sampling unit (gear, quarter, area,
etc.).</p>
<div class="section level5">
<h5 id="psu-estimation">PSU-estimation<a class="anchor" aria-label="anchor" href="#psu-estimation"></a>
</h5>
<p>We first estimate abundance, frequencies, totals and means for each
PSU. We need to specify the domain we want to estimate for. We provide
age so that we get estimates for each age group. We also need to specify
which variables we want means and totals for. We will specify weight and
length:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StoxBioticData</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryExample.html">CatchLotteryExample</a></span></span>
<span><span class="va">IndividualSamplingParametersData</span> <span class="op">=</span> <span class="va">indParameters</span></span>
<span><span class="va">DomainVariables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualAge"</span><span class="op">)</span></span>
<span><span class="va">Variables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualRoundWeight"</span>, <span class="st">"IndividualTotalLength"</span><span class="op">)</span></span>
<span><span class="va">psuEstimates</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPSUEstimate.html">AnalyticalPSUEstimate</a></span><span class="op">(</span>StoxBioticData<span class="op">=</span><span class="va">StoxBioticData</span>, </span>
<span>                                                IndividualSamplingParametersData <span class="op">=</span> <span class="va">IndividualSamplingParametersData</span>, </span>
<span>                                                DomainVariables<span class="op">=</span><span class="va">DomainVariables</span>, </span>
<span>                                                Variables<span class="op">=</span><span class="va">Variables</span><span class="op">)</span></span></code></pre></div>
<p>We now have estimates of abundance and frequency for each age group
for each PSU/haul:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psuEstimates</span><span class="op">$</span><span class="va">Abundance</span><span class="op">)</span></span>
<span><span class="co">#&gt;                       SampleId                                    Stratum</span></span>
<span><span class="co">#&gt;                         &lt;char&gt;                                     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;    Domain Abundance  Frequency</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1      0.00 0.00000000</span></span>
<span><span class="co">#&gt; 2:     10  54928.26 0.05263158</span></span>
<span><span class="co">#&gt; 3:     11  54928.26 0.05263158</span></span>
<span><span class="co">#&gt; 4:     12      0.00 0.00000000</span></span>
<span><span class="co">#&gt; 5:     13      0.00 0.00000000</span></span>
<span><span class="co">#&gt; 6:      2      0.00 0.00000000</span></span></code></pre></div>
<p>Note that domains in this table are just identified by a
text-variable. As for stratification, more detailed information about
the domain is stored in a separate table:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psuEstimates</span><span class="op">$</span><span class="va">DomainVariables</span></span>
<span><span class="co">#&gt;     Domain IndividualAge</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:      1             1</span></span>
<span><span class="co">#&gt;  2:     10            10</span></span>
<span><span class="co">#&gt;  3:     11            11</span></span>
<span><span class="co">#&gt;  4:     12            12</span></span>
<span><span class="co">#&gt;  5:     13            13</span></span>
<span><span class="co">#&gt;  6:      2             2</span></span>
<span><span class="co">#&gt;  7:      3             3</span></span>
<span><span class="co">#&gt;  8:      4             4</span></span>
<span><span class="co">#&gt;  9:      5             5</span></span>
<span><span class="co">#&gt; 10:      6             6</span></span>
<span><span class="co">#&gt; 11:      7             7</span></span>
<span><span class="co">#&gt; 12:      8             8</span></span>
<span><span class="co">#&gt; 13:      9             9</span></span>
<span><span class="co">#&gt; 14:     NA            NA</span></span></code></pre></div>
<p>This reveals that the domain “1” is defined by fish with the value 1
for the variable “IndividualAge”. Note that fish with missing ages have
become their own domain called ‘NA’.</p>
<p>We also have estimates of totals and means of provided variables:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psuEstimates</span><span class="op">$</span><span class="va">Variables</span><span class="op">)</span></span>
<span><span class="co">#&gt;                       SampleId                                    Stratum</span></span>
<span><span class="co">#&gt;                         &lt;char&gt;                                     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: NA/19/2022/10024/20-1-38401 sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;    Domain              Variable    Total  Mean</span></span>
<span><span class="co">#&gt;    &lt;char&gt;                &lt;char&gt;    &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1 IndividualRoundWeight        0   NaN</span></span>
<span><span class="co">#&gt; 2:      1 IndividualTotalLength        0   NaN</span></span>
<span><span class="co">#&gt; 3:     10 IndividualRoundWeight 12139146 221.0</span></span>
<span><span class="co">#&gt; 4:     10 IndividualTotalLength  1730240  31.5</span></span>
<span><span class="co">#&gt; 5:     11 IndividualRoundWeight 11425079 208.0</span></span>
<span><span class="co">#&gt; 6:     11 IndividualTotalLength  1730240  31.5</span></span></code></pre></div>
<p>For domains / age groups with estimated zero abundance, totals are 0,
and means are NaN.</p>
</div>
<div class="section level5">
<h5 id="population-estimation">Population-estimation<a class="anchor" aria-label="anchor" href="#population-estimation"></a>
</h5>
<p>We can no proceed with estimating these parameters for the total
popuation of catches. We use
<em>RstoxFDA::AnalyticalPopulationEstimate</em>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PSUSamplingParametersData</span> <span class="op">=</span> <span class="va">PSUassigment</span></span>
<span><span class="va">AnalyticalPSUEstimateData</span> <span class="op">=</span> <span class="va">psuEstimates</span></span>
<span><span class="va">populationEstimates</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPopulationEstimate.html">AnalyticalPopulationEstimate</a></span><span class="op">(</span><span class="va">PSUSamplingParametersData</span>, </span>
<span>                                                             AnalyticalPSUEstimateData <span class="op">=</span> <span class="va">AnalyticalPSUEstimateData</span><span class="op">)</span></span></code></pre></div>
<p>Which gives abundance, frequencies, means and totals for the entire
population:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">populationEstimates</span><span class="op">$</span><span class="va">Abundance</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;Stratum&gt;</span></span>
<span><span class="co">#&gt;                                                                         Stratum</span></span>
<span><span class="co">#&gt;                                                                          &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;                  Domain Abundance   Frequency</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;     &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  All/IndividualAge:1  12166215 0.014684930</span></span>
<span><span class="co">#&gt; 2: All/IndividualAge:10   3744033 0.004519143</span></span>
<span><span class="co">#&gt; 3: All/IndividualAge:11   2318774 0.002798820</span></span>
<span><span class="co">#&gt; 4: All/IndividualAge:12   2085513 0.002517267</span></span>
<span><span class="co">#&gt; 5: All/IndividualAge:13   1292641 0.001560251</span></span>
<span><span class="co">#&gt; 6:  All/IndividualAge:2 514265071 0.620731006</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">populationEstimates</span><span class="op">$</span><span class="va">Variables</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                         Stratum</span></span>
<span><span class="co">#&gt;                                                                          &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;                  Domain              Variable     Total      Mean</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;                &lt;char&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  All/IndividualAge:1 IndividualRoundWeight 702360170  57.73038</span></span>
<span><span class="co">#&gt; 2:  All/IndividualAge:1 IndividualTotalLength 224959951  18.49055</span></span>
<span><span class="co">#&gt; 3: All/IndividualAge:10 IndividualRoundWeight 840470457 224.48266</span></span>
<span><span class="co">#&gt; 4: All/IndividualAge:10 IndividualTotalLength 114613425  30.61229</span></span>
<span><span class="co">#&gt; 5: All/IndividualAge:11 IndividualRoundWeight 519743141 224.14563</span></span>
<span><span class="co">#&gt; 6: All/IndividualAge:11 IndividualTotalLength  70781025  30.52519</span></span></code></pre></div>
<p>Note that the names of domains have changed, to incorporate any
domains that vary between PSUs (none in this case). The definition is
however still the same, as can be confirmed by inspecting the table of
DomainVariables:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">populationEstimates</span><span class="op">$</span><span class="va">DomainVariables</span></span>
<span><span class="co">#&gt;                   Domain IndividualAge</span></span>
<span><span class="co">#&gt;                   &lt;char&gt;         &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:  All/IndividualAge:1             1</span></span>
<span><span class="co">#&gt;  2: All/IndividualAge:10            10</span></span>
<span><span class="co">#&gt;  3: All/IndividualAge:11            11</span></span>
<span><span class="co">#&gt;  4: All/IndividualAge:12            12</span></span>
<span><span class="co">#&gt;  5: All/IndividualAge:13            13</span></span>
<span><span class="co">#&gt;  6:  All/IndividualAge:2             2</span></span>
<span><span class="co">#&gt;  7:  All/IndividualAge:3             3</span></span>
<span><span class="co">#&gt;  8:  All/IndividualAge:4             4</span></span>
<span><span class="co">#&gt;  9:  All/IndividualAge:5             5</span></span>
<span><span class="co">#&gt; 10:  All/IndividualAge:6             6</span></span>
<span><span class="co">#&gt; 11:  All/IndividualAge:7             7</span></span>
<span><span class="co">#&gt; 12:  All/IndividualAge:8             8</span></span>
<span><span class="co">#&gt; 13:  All/IndividualAge:9             9</span></span>
<span><span class="co">#&gt; 14: All/IndividualAge:NA            NA</span></span></code></pre></div>
<p>We also have full sampling covariance matrices, which will give a
basis for reporting sampling variances:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">populationEstimates</span><span class="op">$</span><span class="va">AbundanceCovariance</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                         Stratum</span></span>
<span><span class="co">#&gt;                                                                          &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 2: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 3: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 4: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 5: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 6: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;                 Domain1              Domain2 AbundanceCovariance</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;               &lt;char&gt;               &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  All/IndividualAge:1  All/IndividualAge:1        8.802669e+13</span></span>
<span><span class="co">#&gt; 2: All/IndividualAge:10  All/IndividualAge:1       -9.691640e+11</span></span>
<span><span class="co">#&gt; 3: All/IndividualAge:10 All/IndividualAge:10        1.500574e+12</span></span>
<span><span class="co">#&gt; 4: All/IndividualAge:11  All/IndividualAge:1       -6.002278e+11</span></span>
<span><span class="co">#&gt; 5: All/IndividualAge:11 All/IndividualAge:10        4.454114e+11</span></span>
<span><span class="co">#&gt; 6: All/IndividualAge:11 All/IndividualAge:11        9.830381e+11</span></span>
<span><span class="co">#&gt;    FrequencyCovariance</span></span>
<span><span class="co">#&gt;                  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        1.282470e-04</span></span>
<span><span class="co">#&gt; 2:       -1.411985e-06</span></span>
<span><span class="co">#&gt; 3:        2.186201e-06</span></span>
<span><span class="co">#&gt; 4:       -8.744781e-07</span></span>
<span><span class="co">#&gt; 5:        6.489245e-07</span></span>
<span><span class="co">#&gt; 6:        1.432198e-06</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="landings-ratio-estimation">Landings-ratio-estimation<a class="anchor" aria-label="anchor" href="#landings-ratio-estimation"></a>
</h5>
<p>We have not yet utilized the census information on landings. We can
improve our estimate with a ratio estimator that corrects the abundance
with the ratio between estimated total weight across all domains / age
groups and the reported total landings. The function
<em>RstoxFDA::AnalyticalRatioEstimate</em> supports this, but needs the
strata or PSU-domains to be in correspondence with variables in the
landings, which is why we wanted the PSUs stratification to be defined
by ‘Species’. We perform the ratio estimate, and indicate in the
argument ‘StratificationVariables’ that we want to match to landings by
the column ‘Species’:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">populationEstimates</span></span>
<span><span class="va">StoxLandingData</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryLandingExample.html">CatchLotteryLandingExample</a></span></span>
<span><span class="va">WeightVariable</span> <span class="op">=</span> <span class="st">"IndividualRoundWeight"</span></span>
<span><span class="va">ratioEst</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalRatioEstimate.html">AnalyticalRatioEstimate</a></span><span class="op">(</span>AnalyticalPopulationEstimateData <span class="op">=</span> <span class="va">AnalyticalPopulationEstimateData</span>,</span>
<span>                                              StoxLandingData <span class="op">=</span> <span class="va">StoxLandingData</span>, </span>
<span>                                              WeightVariable <span class="op">=</span> <span class="va">WeightVariable</span>, StratificationVariables <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span></code></pre></div>
<p>Comparing this with the estimate above, the frequencies should be
nearly identical, but some corrections are expected for the
abundances:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">ratioEst</span><span class="op">$</span><span class="va">Abundance</span>, <span class="va">populationEstimates</span><span class="op">$</span><span class="va">Abundance</span>, </span>
<span>      by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stratum"</span>, <span class="st">"Domain"</span><span class="op">)</span>, suffix<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".ratioEst"</span>, <span class="st">".designEst"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;Stratum, Domain&gt;</span></span>
<span><span class="co">#&gt;                                                                          Stratum</span></span>
<span><span class="co">#&gt;                                                                           &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  2: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  3: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  4: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  5: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  6: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  7: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  8: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;  9: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 10: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 11: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 12: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 13: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt; 14: PSU-stratum:Nordsjo Lower-stratum:sild'G05/161722.G05/126417/Clupea harengus</span></span>
<span><span class="co">#&gt;                   Domain Abundance.ratioEst Frequency.ratioEst</span></span>
<span><span class="co">#&gt;                   &lt;char&gt;              &lt;num&gt;              &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:  All/IndividualAge:1           12945206        0.014684930</span></span>
<span><span class="co">#&gt;  2: All/IndividualAge:10            3983760        0.004519143</span></span>
<span><span class="co">#&gt;  3: All/IndividualAge:11            2467243        0.002798820</span></span>
<span><span class="co">#&gt;  4: All/IndividualAge:12            2219046        0.002517267</span></span>
<span><span class="co">#&gt;  5: All/IndividualAge:13            1375408        0.001560251</span></span>
<span><span class="co">#&gt;  6:  All/IndividualAge:2          547192997        0.620731006</span></span>
<span><span class="co">#&gt;  7:  All/IndividualAge:3          111936107        0.126979352</span></span>
<span><span class="co">#&gt;  8:  All/IndividualAge:4           35273048        0.040013440</span></span>
<span><span class="co">#&gt;  9:  All/IndividualAge:5           20207531        0.022923248</span></span>
<span><span class="co">#&gt; 10:  All/IndividualAge:6           75347636        0.085473707</span></span>
<span><span class="co">#&gt; 11:  All/IndividualAge:7           12479586        0.014156735</span></span>
<span><span class="co">#&gt; 12:  All/IndividualAge:8           29953066        0.033978499</span></span>
<span><span class="co">#&gt; 13:  All/IndividualAge:9           12917612        0.014653627</span></span>
<span><span class="co">#&gt; 14: All/IndividualAge:NA           13231744        0.015009976</span></span>
<span><span class="co">#&gt;     Abundance.designEst Frequency.designEst</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;               &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:            12166215         0.014684930</span></span>
<span><span class="co">#&gt;  2:             3744033         0.004519143</span></span>
<span><span class="co">#&gt;  3:             2318774         0.002798820</span></span>
<span><span class="co">#&gt;  4:             2085513         0.002517267</span></span>
<span><span class="co">#&gt;  5:             1292641         0.001560251</span></span>
<span><span class="co">#&gt;  6:           514265071         0.620731006</span></span>
<span><span class="co">#&gt;  7:           105200231         0.126979352</span></span>
<span><span class="co">#&gt;  8:            33150454         0.040013440</span></span>
<span><span class="co">#&gt;  9:            18991521         0.022923248</span></span>
<span><span class="co">#&gt; 10:            70813511         0.085473707</span></span>
<span><span class="co">#&gt; 11:            11728614         0.014156735</span></span>
<span><span class="co">#&gt; 12:            28150608         0.033978499</span></span>
<span><span class="co">#&gt; 13:            12140281         0.014653627</span></span>
<span><span class="co">#&gt; 14:            12435509         0.015009976</span></span></code></pre></div>
<p>The function <em>RstoxFDA::AnalyticalRatioEstimate</em> also supports
other kinds of ratio estimation based on only frequencies and mean
weights, so that a total abundance estimate can be obtained even for
sampling programs with less detailed information about the sampling
parameters.</p>
<p>Finally we can report the domain estimate:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">ratioEst</span></span>
<span><span class="va">PlusGroup</span> <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="va">IntervalWidth</span> <span class="op">=</span> <span class="fl">.9</span></span>
<span><span class="va">Decimals</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">Unit</span> <span class="op">=</span> <span class="st">"10^6 individuals"</span></span>
<span><span class="va">caaReport</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReportAnalyticalCatchAtAge.html">ReportAnalyticalCatchAtAge</a></span><span class="op">(</span>AnalyticalPopulationEstimateData <span class="op">=</span> <span class="va">AnalyticalPopulationEstimateData</span>, </span>
<span>                                        PlusGroup <span class="op">=</span> <span class="va">PlusGroup</span>, </span>
<span>                                        IntervalWidth <span class="op">=</span> <span class="va">IntervalWidth</span>, </span>
<span>                                        Decimals <span class="op">=</span> <span class="va">Decimals</span>, </span>
<span>                                        Unit <span class="op">=</span> <span class="va">Unit</span><span class="op">)</span></span>
<span><span class="va">caaReport</span><span class="op">$</span><span class="va">NbyAge</span></span>
<span><span class="co">#&gt;     AgeGroup   Age CatchAtAge    SD   Low  High</span></span>
<span><span class="co">#&gt;       &lt;char&gt; &lt;num&gt;      &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   Age NA     0         13    10     0    29</span></span>
<span><span class="co">#&gt;  2:    Age 1     1         13    10     0    29</span></span>
<span><span class="co">#&gt;  3:    Age 2     2        547    60   449   645</span></span>
<span><span class="co">#&gt;  4:    Age 3     3        112    19    80   144</span></span>
<span><span class="co">#&gt;  5:    Age 4     4         35     8    23    48</span></span>
<span><span class="co">#&gt;  6:    Age 5     5         20     4    14    26</span></span>
<span><span class="co">#&gt;  7:    Age 6     6         75    19    44   107</span></span>
<span><span class="co">#&gt;  8:    Age 7     7         12     3     8    17</span></span>
<span><span class="co">#&gt;  9:    Age 8     8         30     8    17    43</span></span>
<span><span class="co">#&gt; 10:   Age 9+     9         23     5    15    31</span></span></code></pre></div>
<p>Note that the domain of fish with missing age is preserved and
assigned the minimum age 0, and we have added a plus group with minimum
age 9. Downstream use may not support undefined age groups, and NAs may
have to be dealt with. RstoxFDA have limited support for this. The
easiest is to remove NA individuals
(<em>RstoxData</em>::FilterStoxBiotic), or not calculate selection
probabilites for them
(<em>RstoxFDA::ComputeIndividualSamplingParameters</em>). These options
corresponds to the somewhat unrealistic assumption that ages are missing
at random. The report table is compatible with those produced by other
estimation procedures, such as Reca, so that we can use the same
plotting functions:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ReportFdaCatchAtAgeData</span> <span class="op">=</span> <span class="va">caaReport</span></span>
<span><span class="fu"><a href="../reference/PlotCatchAtAgeTotals.html">PlotCatchAtAgeTotals</a></span><span class="op">(</span>ReportFdaCatchAtAgeData <span class="op">=</span> <span class="va">ReportFdaCatchAtAgeData</span><span class="op">)</span></span></code></pre></div>
<p><img src="Stox-Analytical_files/figure-html/PlotCatchAtAgeTotals-1.png" width="700"></p>
</div>
<div class="section level5">
<h5 id="complex-domains">Complex domains<a class="anchor" aria-label="anchor" href="#complex-domains"></a>
</h5>
<p>For the sake of illustration we will redo the computation with
domains that also include other variables beside age. We will first add
another fish-observation to the domain defintion, namely sex:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Redo psu estimates with new domain definition</span></span>
<span><span class="va">DomainVariables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualAge"</span>, <span class="st">"IndividualSex"</span><span class="op">)</span></span>
<span><span class="va">psuEstimates</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPSUEstimate.html">AnalyticalPSUEstimate</a></span><span class="op">(</span>StoxBioticData<span class="op">=</span><span class="va">StoxBioticData</span>, </span>
<span>                                                IndividualSamplingParametersData <span class="op">=</span> <span class="va">IndividualSamplingParametersData</span>,</span>
<span>                                                DomainVariables<span class="op">=</span><span class="va">DomainVariables</span>, </span>
<span>                                                Variables<span class="op">=</span><span class="va">Variables</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Redo population estimate</span></span>
<span><span class="va">AnalyticalPSUEstimateData</span> <span class="op">=</span> <span class="va">psuEstimates</span></span>
<span><span class="va">populationEstimates</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPopulationEstimate.html">AnalyticalPopulationEstimate</a></span><span class="op">(</span><span class="va">PSUSamplingParametersData</span>, </span>
<span>                                                             AnalyticalPSUEstimateData <span class="op">=</span> <span class="va">AnalyticalPSUEstimateData</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Redo ratio estimate</span></span>
<span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">populationEstimates</span></span>
<span><span class="va">ratioEst</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalRatioEstimate.html">AnalyticalRatioEstimate</a></span><span class="op">(</span>AnalyticalPopulationEstimateData<span class="op">=</span><span class="va">AnalyticalPopulationEstimateData</span>,</span>
<span>                                              StoxLandingData <span class="op">=</span> <span class="va">StoxLandingData</span>, </span>
<span>                                              WeightVariable <span class="op">=</span> <span class="va">WeightVariable</span>, StratificationVariables <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Report</span></span>
<span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">ratioEst</span></span>
<span><span class="va">caaReport</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReportAnalyticalCatchAtAge.html">ReportAnalyticalCatchAtAge</a></span><span class="op">(</span>AnalyticalPopulationEstimateData <span class="op">=</span> <span class="va">AnalyticalPopulationEstimateData</span>, PlusGroup <span class="op">=</span> <span class="va">PlusGroup</span>, IntervalWidth <span class="op">=</span> <span class="va">IntervalWidth</span>, Decimals <span class="op">=</span> <span class="va">Decimals</span>, <span class="st">"10^6 individuals"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">ReportFdaCatchAtAgeData</span> <span class="op">=</span> <span class="va">caaReport</span></span>
<span><span class="fu"><a href="../reference/PlotCatchAtAgeTotals.html">PlotCatchAtAgeTotals</a></span><span class="op">(</span>ReportFdaCatchAtAgeData <span class="op">=</span> <span class="va">ReportFdaCatchAtAgeData</span><span class="op">)</span></span></code></pre></div>
<p><img src="Stox-Analytical_files/figure-html/ageSexdomain-1.png" width="700"></p>
<p>As before, note that the exact variables and values that define the
domains are documented on the ‘DomainVariabes’-table:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">AnalyticalPopulationEstimateData</span><span class="op">$</span><span class="va">DomainVariables</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                  Domain IndividualAge IndividualSex</span></span>
<span><span class="co">#&gt;                                  &lt;char&gt;         &lt;int&gt;        &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  All/IndividualAge:1/IndividualSex:F             1             F</span></span>
<span><span class="co">#&gt; 2:  All/IndividualAge:1/IndividualSex:M             1             M</span></span>
<span><span class="co">#&gt; 3: All/IndividualAge:10/IndividualSex:F            10             F</span></span>
<span><span class="co">#&gt; 4: All/IndividualAge:10/IndividualSex:M            10             M</span></span>
<span><span class="co">#&gt; 5: All/IndividualAge:11/IndividualSex:F            11             F</span></span>
<span><span class="co">#&gt; 6: All/IndividualAge:11/IndividualSex:M            11             M</span></span></code></pre></div>
<p>We can also add PSU-domains, such as quarter. Some of these may be
put in correspondence with landing-statistics, and provide a
higher-resolution allocation of landings in the ratio-estimation,
although typically at the cost of somewhat lower precision in domain
estimates.</p>
<p>We will first use standard StoX tools to add the quarter to both
landings and samples:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quarter</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/DefinePeriod.html">DefinePeriod</a></span><span class="op">(</span>TemporalCategory <span class="op">=</span> <span class="st">"Quarter"</span><span class="op">)</span></span>
<span><span class="va">StoxBioticDataWquarter</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AddPeriodStoxBiotic.html">AddPeriodStoxBiotic</a></span><span class="op">(</span><span class="va">StoxBioticData</span>, <span class="va">quarter</span>, <span class="st">"Quarter"</span><span class="op">)</span></span>
<span><span class="va">StoxLandingDataWquarter</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AddPeriodStoxLanding.html">AddPeriodStoxLanding</a></span><span class="op">(</span><span class="va">StoxLandingData</span>, <span class="va">quarter</span>, <span class="st">"Quarter"</span><span class="op">)</span></span></code></pre></div>
<p>And then specify the PSU domains, when computing sampling parameters
for individuals:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DomainVariables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualAge"</span><span class="op">)</span></span>
<span><span class="va">PSUDomainVariables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Quarter"</span><span class="op">)</span></span>
<span><span class="va">StoxBioticData</span> <span class="op">&lt;-</span> <span class="va">StoxBioticDataWquarter</span></span>
<span><span class="va">StoxLandingData</span> <span class="op">&lt;-</span> <span class="va">StoxLandingDataWquarter</span></span>
<span><span class="va">psuEstimates</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPSUEstimate.html">AnalyticalPSUEstimate</a></span><span class="op">(</span>StoxBioticData <span class="op">=</span> <span class="va">StoxBioticData</span>,</span>
<span>                                                IndividualSamplingParametersData <span class="op">=</span> <span class="va">IndividualSamplingParametersData</span>,</span>
<span>                                                DomainVariables <span class="op">=</span> <span class="va">DomainVariables</span>, </span>
<span>                                                Variables <span class="op">=</span> <span class="va">Variables</span>, </span>
<span>                                                PSUDomainVariables <span class="op">=</span> <span class="va">PSUDomainVariables</span><span class="op">)</span></span></code></pre></div>
<p>Otherwise the estimation is exactly as before:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Redo psu estimates with new domain definition</span></span>
<span><span class="va">DomainVariables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IndividualAge"</span><span class="op">)</span></span>
<span><span class="va">PSUDomainVariables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Quarter"</span><span class="op">)</span></span>
<span><span class="va">StoxBioticData</span> <span class="op">&lt;-</span> <span class="va">StoxBioticDataWquarter</span></span>
<span><span class="va">StoxLandingData</span> <span class="op">&lt;-</span> <span class="va">StoxLandingDataWquarter</span></span>
<span><span class="va">psuEstimates</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPSUEstimate.html">AnalyticalPSUEstimate</a></span><span class="op">(</span>StoxBioticData <span class="op">=</span> <span class="va">StoxBioticData</span>, </span>
<span>                                                IndividualSamplingParametersData <span class="op">=</span> <span class="va">IndividualSamplingParametersData</span>,</span>
<span>                                                DomainVariables <span class="op">=</span> <span class="va">DomainVariables</span>, </span>
<span>                                                Variables <span class="op">=</span> <span class="va">Variables</span>, </span>
<span>                                                PSUDomainVariables <span class="op">=</span> <span class="va">PSUDomainVariables</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Redo population estimate</span></span>
<span><span class="va">AnalyticalPSUEstimateData</span> <span class="op">=</span> <span class="va">psuEstimates</span></span>
<span><span class="va">populationEstimates</span> <span class="op">=</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalPopulationEstimate.html">AnalyticalPopulationEstimate</a></span><span class="op">(</span>PSUSamplingParametersData <span class="op">=</span> <span class="va">PSUSamplingParametersData</span>, </span>
<span>                                                             AnalyticalPSUEstimateData <span class="op">=</span> <span class="va">AnalyticalPSUEstimateData</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Redo ratio estimate</span></span>
<span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">populationEstimates</span></span>
<span><span class="va">StratificationVariables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Species"</span><span class="op">)</span></span>
<span><span class="va">ratioEst</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AnalyticalRatioEstimate.html">AnalyticalRatioEstimate</a></span><span class="op">(</span>AnalyticalPopulationEstimateData <span class="op">=</span> <span class="va">AnalyticalPopulationEstimateData</span>,</span>
<span>                                              StoxLandingData <span class="op">=</span> <span class="va">StoxLandingData</span>, </span>
<span>                                              WeightVariable <span class="op">=</span> <span class="va">WeightVariable</span>, </span>
<span>                                              StratificationVariables <span class="op">=</span> <span class="va">StratificationVariables</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in stoxWarning(paste("No Domain Variables configured, although</span></span>
<span><span class="co">#&gt; appropriately named domains are available in Landings", : StoX: No Domain</span></span>
<span><span class="co">#&gt; Variables configured, although appropriately named domains are available in</span></span>
<span><span class="co">#&gt; Landings Quarter</span></span>
<span></span>
<span><span class="co"># Report</span></span>
<span><span class="va">AnalyticalPopulationEstimateData</span> <span class="op">=</span> <span class="va">ratioEst</span></span>
<span><span class="va">Unit</span> <span class="op">=</span> <span class="st">"10^6 individuals"</span></span>
<span><span class="va">caaReport</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReportAnalyticalCatchAtAge.html">ReportAnalyticalCatchAtAge</a></span><span class="op">(</span>AnalyticalPopulationEstimateData <span class="op">=</span> <span class="va">AnalyticalPopulationEstimateData</span>,</span>
<span>                                        PlusGroup <span class="op">=</span> <span class="va">PlusGroup</span>, </span>
<span>                                        IntervalWidth <span class="op">=</span> <span class="va">IntervalWidth</span>, </span>
<span>                                        Decimals <span class="op">=</span> <span class="va">Decimals</span>,</span>
<span>                                        Unit <span class="op">=</span> <span class="va">Unit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">ReportFdaCatchAtAgeData</span> <span class="op">=</span> <span class="va">caaReport</span></span>
<span><span class="fu"><a href="../reference/PlotCatchAtAgeTotals.html">PlotCatchAtAgeTotals</a></span><span class="op">(</span>ReportFdaCatchAtAgeData <span class="op">=</span> <span class="va">ReportFdaCatchAtAgeData</span><span class="op">)</span></span></code></pre></div>
<p><img src="Stox-Analytical_files/figure-html/estimateWpsuDomains-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="analytical-estimates-for-incomplete-records">Analytical estimates for incomplete records<a class="anchor" aria-label="anchor" href="#analytical-estimates-for-incomplete-records"></a>
</h3>
<p>Sometimes samples that successfully reach IMR are only partially
measured. This could be because they arrived too late, the sample was of
poor quality, or because some parameters (e.g. age) was not prioritized
for observation due to cost or time constraints. In this situation there
may be a mismatch between the PSUs that are listed as sampled PSUs in
the file with sampling parameters, and what is made available for
estimation in StoX. ‘AssignPSUSamplingParameters’ will treat these as if
they were regular non-response samples, and issue a warning about that.
At this point we must consider if we have a representative sub-sample of
the PSUs, and re-configure our estimation.</p>
</div>
<div class="section level3">
<h3 id="computing-sampling-parameters">Computing sampling parameters<a class="anchor" aria-label="anchor" href="#computing-sampling-parameters"></a>
</h3>
<p>If actual sampling parameters are not available, we could
approximately compute them from the filtered samples. Below is an
example on how to do this for samples from the catch lottery, using the
function <em>RstoxFDA::ComputePSUSamplingParameters</em>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StoxBioticData</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="va"><a href="../reference/CatchLotteryExample.html">CatchLotteryExample</a></span></span>
<span><span class="va">DefinitionMethod</span> <span class="op">&lt;-</span> <span class="st">"ProportionalPoissonSampling"</span></span>
<span><span class="va">SamplingUnitId</span> <span class="op">&lt;-</span> <span class="st">"serialnumber"</span></span>
<span><span class="va">StratumName</span> <span class="op">&lt;-</span> <span class="st">"Nordsjo2022"</span></span>
<span><span class="va">Quoata</span> <span class="op">&lt;-</span> <span class="fl">445000000</span></span>
<span><span class="va">ExpectedSampleSize</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">PSUparameters</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/ComputePSUSamplingParameters.html">ComputePSUSamplingParameters</a></span><span class="op">(</span>StoxBioticData <span class="op">=</span> <span class="va">StoxBioticData</span>,</span>
<span>                                                        DefinitionMethod <span class="op">=</span> <span class="va">DefinitionMethod</span>,</span>
<span>                                                        SamplingUnitId <span class="op">=</span> <span class="va">SamplingUnitId</span>,</span>
<span>                                                        StratumName<span class="op">=</span><span class="va">StratumName</span>,</span>
<span>                                                        Quota <span class="op">=</span> <span class="va">Quoata</span>,</span>
<span>                                                        ExpectedSampleSize <span class="op">=</span> <span class="va">ExpectedSampleSize</span><span class="op">)</span></span></code></pre></div>
<p>In order to have estimates matchable with landings, we need to add
some stratification variables, using the function
<em>RstoxFDA::AddPsuStratificationVariables</em>. We will add the
variable ‘CountryVessel’ as stratification variable:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PSUSamplingParametersData</span> <span class="op">&lt;-</span> <span class="va">PSUparameters</span></span>
<span><span class="va">StratificationVariables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CountryVessel"</span><span class="op">)</span></span>
<span><span class="va">StratificationVariablesTable</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>Stratum<span class="op">=</span><span class="va">StratumName</span>, CountryVessel<span class="op">=</span><span class="st">"NOR"</span><span class="op">)</span></span>
<span><span class="va">PSUparameters</span> <span class="op">&lt;-</span> <span class="fu">RstoxFDA</span><span class="fu">::</span><span class="fu"><a href="../reference/AddPsuStratificationVariables.html">AddPsuStratificationVariables</a></span><span class="op">(</span>PSUSamplingParametersData<span class="op">=</span><span class="va">PSUSamplingParametersData</span>,</span>
<span>                                                         StratificationVariables <span class="op">=</span> <span class="va">StratificationVariables</span>,</span>
<span>                                                         StratificationVariablesTable <span class="op">=</span> <span class="va">StratificationVariablesTable</span></span>
<span>                                                          <span class="op">)</span></span></code></pre></div>
<p>The estimation can then proceed as usual. We have only made two small
modifications to the usual workflow. We have removed the function
<em>RstoxFDA::ReadPSUSamplingParameters</em>, and replaced it with the
functions: <em>RstoxFDA::ComputePSUSamplingParameters</em> and
<em>RstoxFDA::AddPsuStratificationVariables</em>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edvin Fuglebakk, Arne Johannes Holmin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
